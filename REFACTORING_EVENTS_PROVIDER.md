# Рефакторинг EventsProvider

## Обзор

Проведен рефакторинг `EventsProvider` для улучшения организации кода и разделения ответственности. Файл из 1200+ строк разбит на модульную архитектуру с сервисным слоем.

## Структура до рефакторинга

```
lib/providers/
  └── events_provider.dart (1200+ строк)
      - Прямая работа с Firestore
      - Все типы событий в одном файле
      - Смешанная логика CRUD, таймеров, статистики
```

## Структура после рефакторинга

```
lib/
├── services/                          # НОВОЕ: Сервисный слой
│   ├── events_repository.dart         # Базовые CRUD операции
│   ├── event_details_service.dart     # Работа с деталями событий
│   ├── sleep_service.dart             # События сна
│   ├── feeding_service.dart           # События кормления
│   ├── diaper_service.dart            # События подгузника
│   ├── medicine_service.dart          # Лекарства
│   ├── measurements_service.dart      # Измерения (вес, рост, голова)
│   ├── activities_service.dart        # Активности (прогулка, купание, бутылка)
│   └── statistics_service.dart        # Статистика
│
└── providers/
    ├── events_provider.dart           # Рефакторенный (640 строк)
    └── events_provider_old.dart       # Backup оригинала
```

## Преимущества новой архитектуры

### 1. **Разделение ответственности (SoC)**
- Каждый сервис отвечает за свою область
- Repository изолирует работу с Firestore
- Provider координирует работу сервисов

### 2. **Тестируемость**
- Сервисы можно тестировать независимо
- Легко подменять зависимости (DI)
- Mock'и для unit-тестов

### 3. **Читаемость**
- Вместо 1200 строк теперь ~10 файлов по 50-200 строк
- Легко найти нужный функционал
- Понятная структура папок

### 4. **Поддерживаемость**
- Изменения в одном типе событий не затрагивают другие
- Проще добавлять новые типы событий
- Меньше конфликтов при работе в команде

### 5. **Переиспользование**
- Сервисы можно использовать не только из Provider
- Repository может работать с разными источниками данных

## Описание сервисов

### EventsRepository
Базовый репозиторий для работы с Firestore
- CRUD операции для событий
- Streams событий (все, за сегодня, активные)
- Фильтрация по типам

### EventDetailsService
Управление деталями событий
- Sleep Details (тип сна, примечания)
- Feeding Details (грудь, длительность)
- Diaper Details (тип подгузника)
- Medicine Details (ID лекарства)

### SleepService
События сна
- Добавление завершенного события
- Запуск/остановка таймера сна
- Получение активного события сна

### FeedingService
События кормления
- Добавление завершенного события
- Запуск/остановка таймера кормления
- Управление состоянием таймера (левая/правая грудь)

### DiaperService
События подгузника
- Добавление события с типом подгузника (мокрый/грязный/оба)

### MedicineService
Лекарства и приемы
- События приема лекарств
- Справочник лекарств семьи
- CRUD операции для лекарств

### MeasurementsService
Измерения ребенка
- Вес (weightKg)
- Рост (heightCm)
- Окружность головы (headCircumferenceCm)

### ActivitiesService
Прогулки, купание, бутылка
- Прогулки (walk) с таймером
- Купание (bath)
- Бутылка (bottle) с типом и объемом

### StatisticsService
Расчет статистики
- Статистика за период
- Подсчет количества событий
- Подсчет длительности

## API без изменений

Публичный API `EventsProvider` остался прежним, поэтому изменения в коде приложения **НЕ ТРЕБУЮТСЯ**.

Все методы работают как раньше:
```dart
// Было
eventsProvider.addSleepEvent(...);

// Осталось
eventsProvider.addSleepEvent(...);
```

## Расширение функциональности

### Добавление нового типа события

1. Создать сервис `lib/services/new_event_service.dart`
2. Реализовать методы add/start/stop
3. Добавить методы в `EventsProvider`
4. Использовать в UI

Пример:
```dart
// 1. Создать сервис
class NewEventService {
  final EventsRepository _repo;
  
  Future<String?> addNewEvent(...) async {
    // Реализация
  }
}

// 2. Добавить в EventsProvider
class EventsProvider {
  final NewEventService _newEventService;
  
  Future<String?> addNewEvent(...) async {
    return await _newEventService.addNewEvent(...);
  }
}
```

## Миграция

Старый файл сохранен как `events_provider_old.dart` для справки. Можно удалить после проверки работоспособности.

```bash
# Удалить после проверки
rm lib/providers/events_provider_old.dart
```

## Тестирование

После рефакторинга необходимо:
1. ✅ Проверить компиляцию (dart analyze) - OK
2. ⏳ Запустить приложение
3. ⏳ Проверить все типы событий
4. ⏳ Проверить таймеры
5. ⏳ Проверить удаление событий

## Следующие шаги

1. Написать unit-тесты для сервисов
2. Добавить integration тесты
3. Рассмотреть использование Riverpod для DI
4. Документация JSDoc для каждого сервиса
